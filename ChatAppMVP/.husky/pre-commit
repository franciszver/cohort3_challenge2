#!/bin/sh
# =============================================================================
# STRICT PRE-COMMIT VALIDATION - AI AGENT SAFETY CRITICAL
# =============================================================================
# This hook prevents ANY commits when tests are failing
# ZERO tolerance policy for broken code

echo "üß™ Running mandatory pre-commit validation..."
echo "ü§ñ AI SAFETY: This hook blocks commits with ANY test failures"
echo ""

# Run TypeScript compilation check
echo "üìù Checking TypeScript compilation..."
npx tsc --noEmit --pretty false > ts-results.log 2>&1
TS_EXIT_CODE=$?

if [ $TS_EXIT_CODE -ne 0 ]; then
  echo "‚ùå COMMIT BLOCKED: TypeScript compilation failed"
  echo ""
  echo "üîç TypeScript Errors:"
  cat ts-results.log
  echo ""
  echo "üìã Resolution Options:"
  echo "  1. Fix TypeScript errors (recommended)"
  echo "  2. Check ts-results.log for details"
  echo "  3. Use --no-verify to bypass (NOT recommended for AI agents)"
  echo ""
  echo "‚ö†Ô∏è  AI AGENTS: This commit is BLOCKED until TypeScript passes"
  rm -f ts-results.log
  exit 1
fi

# Count total tests and run them
echo "üß™ Running test suite..."
TOTAL_TESTS=$(npm test -- --listTests --json 2>/dev/null | jq length 2>/dev/null || echo "unknown")
npm run test:ci --silent > test-results.log 2>&1
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
  FAILED_COUNT=$(grep -c "FAIL\|‚úï\|Failed" test-results.log 2>/dev/null || echo "unknown")
  
  echo ""
  echo "‚ùå COMMIT BLOCKED: Tests are failing"
  echo "üìä Test Status: Failed tests detected (${FAILED_COUNT} failures)"
  echo "üìä Total tests: ${TOTAL_TESTS}"
  echo ""
  echo "üîç Test Failure Details:"
  grep -A 5 -B 2 "FAIL\|‚úï\|Error" test-results.log 2>/dev/null | head -20
  echo ""
  echo "üìã Resolution Options:"
  echo "  1. Fix failing tests (REQUIRED for AI agents)"
  echo "  2. Run: npm test (for detailed output)"
  echo "  3. View: cat test-results.log (full results)"
  echo "  4. Use: git commit --no-verify (requires human approval)"
  echo ""
  echo "‚ö†Ô∏è  CRITICAL: AI AGENTS MUST NOT COMMIT WITH FAILING TESTS"
  echo "‚ö†Ô∏è  This is a safety mechanism to prevent broken code"
  echo ""
  rm -f test-results.log ts-results.log
  exit 1
fi

# All checks passed
echo "‚úÖ TypeScript compilation: PASSED"
echo "‚úÖ Test suite: PASSED (${TOTAL_TESTS} tests)"
echo "‚úÖ All pre-commit validations: PASSED"
echo ""
echo "üöÄ Commit approved - all safety checks passed!"

# Cleanup
rm -f test-results.log ts-results.log
exit 0
npm run test:ci
